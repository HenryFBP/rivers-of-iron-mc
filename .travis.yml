# require the branch name to be release (note for PRs this is the base branch name)
branches:
  only:
    - release
language: go
go:
  - "1.13"
os: linux
dist: xenial
install:
  # - go get -v github.com/comp500/packwiz
  - echo 'lol install :)'
script:
  - echo "lol script :)"
before_deploy:
  # Set up git user name and tag this commit
  - git config --local user.name "Henry Post"
  - git config --local user.email "HenryFBP@gmail.com"
  # - export TRAVIS_TAG=${TRAVIS_TAG:-$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)}
  - export VERSION_TAG="`cat VERSION`"
  - echo "$VERSION_TAG" > VERSION_TAG
  - git tag -l --contains HEAD > HEAD_TAG

  - echo "Version tag - `cat VERSION_TAG`"
  - echo "Latest commit's tag - `cat HEAD_TAG`"
  
  # Make sure the tag of the most recent commit is the same as the file...
  - if cmp -s "VERSION_TAG" "HEAD_TAG"; then
      printf 'Last commit was tagged correctly.'
    else
      printf 'Last commit was not tagged correctly. It does not match.'
    fi

  - echo "Releasing RoI ${VERSION_TAG}..."
  # - git tag "${VERSION_TAG}" # user does this themselves now...

  - git clone https://github.com/comp500/packwiz
  - pushd packwiz
  - go install .
  - popd

  - packwiz refresh
  - packwiz cf export
  - mv export.zip "rivers-of-iron-release-${VERSION_TAG}.zip"
  - ls -lash
deploy:
  provider: releases
  api_key: "GITHUB OAUTH TOKEN"
  file:
    - "rivers-of-iron-release-${VERSION_TAG}.zip" #todo not this file, export.zip
  skip_cleanup: true
  on:
    tags: true
    repo: HenryFBP/rivers-of-iron-mc
    branch: release
